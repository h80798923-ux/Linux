name: Build TrixieOS (PC Installer + VM Live)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Deps
      run: |
        sudo apt update
        sudo apt install -y \
        build-essential bc bison flex libssl-dev libelf-dev \
        squashfs-tools xorriso grub-pc-bin \
        wget git xz-utils

    - name: Kernel
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        make -j$(nproc)
        mkdir -p $GITHUB_WORKSPACE/rootfs/boot
        make modules_install INSTALL_MOD_PATH=$GITHUB_WORKSPACE/rootfs
        make install INSTALL_PATH=$GITHUB_WORKSPACE/rootfs/boot

    - name: RootFS
      run: |
        mkdir -p rootfs/{bin,sbin,etc,proc,sys,usr,dev,home,tmp}
        echo 'NAME="TrixieOS"' > rootfs/etc/os-release
        echo 'ID=trixieos' >> rootfs/etc/os-release

    - name: apk-tools (repo only)
      run: |
        git clone https://git.alpinelinux.org/apk-tools
        cd apk-tools && make
        make install DESTDIR=$GITHUB_WORKSPACE/rootfs
        mkdir -p rootfs/etc/apk
        echo https://dl-cdn.alpinelinux.org/alpine/latest-stable/main > rootfs/etc/apk/repositories

    - name: PRA
      run: |
        cat << 'EOF' > rootfs/usr/bin/pra
        #!/bin/sh
        case "$1" in
          install) apk add "$2";;
          remove) apk del "$2";;
          update) apk update;;
          search) apk search "$2";;
          *) echo "pra install|remove|update|search";;
        esac
        EOF
        chmod +x rootfs/usr/bin/pra
        chmod 700 rootfs/sbin/apk

    - name: SquashFS
      run: |
        mkdir iso
        mksquashfs rootfs iso/rootfs.squashfs -comp xz

    - name: PC Installer ISO
      run: |
        mkdir -p pc/boot/grub
        cp iso/rootfs.squashfs pc/
        cat << 'EOF' > pc/boot/grub/grub.cfg
        set timeout=3
        menuentry "Install TrixieOS" {
          linux /boot/vmlinuz root=/dev/ram0 rw
          initrd /boot/initrd
        }
        EOF
        grub-mkrescue -o TrixieOS-Installer-PC.iso pc

    - name: VM Live ISO
      run: |
        mkdir -p vm/boot/grub
        cp iso/rootfs.squashfs vm/
        cat << 'EOF' > vm/boot/grub/grub.cfg
        set timeout=3
        menuentry "TrixieOS Live (VM)" {
          linux /boot/vmlinuz root=/dev/ram0 rw
          initrd /boot/initrd
        }
        EOF
        grub-mkrescue -o TrixieOS-Live-VM.iso vm

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS-ISOs
        path: |
          TrixieOS-Installer-PC.iso
          TrixieOS-Live-VM.iso

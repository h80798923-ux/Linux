name: TrixieEdu XFCE macOS Style ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          live-build \
          debootstrap \
          squashfs-tools \
          xorriso \
          isolinux \
          syslinux-common \
          curl

    - name: Prepare build directory
      run: |
        mkdir trixieedu
        cd trixieedu
        lb config \
          --mode debian \
          --distribution bookworm \
          --archive-areas "main contrib non-free non-free-firmware" \
          --binary-images iso-hybrid \
          --debian-installer false \
          --bootappend-live "boot=live quiet splash loglevel=0 systemd.show_status=false vt.global_cursor_default=0"

    - name: Package list (XFCE + macOS style + Chrome + WiFi)
      run: |
        cd trixieedu
        mkdir -p config/package-lists
        cat > config/package-lists/edu.list.chroot << 'EOF'
        xfce4
        xfce4-goodies
        plank
        lightdm
        lightdm-gtk-greeter
        network-manager
        network-manager-gnome
        firmware-linux
        firmware-linux-nonfree
        firmware-iwlwifi
        alsa-utils
        pulseaudio
        pavucontrol
        sudo
        curl
        wget
        ca-certificates
        fonts-noto
        firefox-esr
        vlc
        gimp
        EOF

    - name: Install Google Chrome
      run: |
        cd trixieedu
        mkdir -p config/includes.chroot/tmp
        cat > config/hooks/normal/020-chrome.chroot << 'EOF'
        #!/bin/sh
        wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        apt install -y ./google-chrome-stable_current_amd64.deb
        rm -f google-chrome-stable_current_amd64.deb
        EOF
        chmod +x config/hooks/normal/020-chrome.chroot

    - name: Create user (ogretmen)
      run: |
        cd trixieedu
        mkdir -p config/hooks/normal
        cat > config/hooks/normal/010-user.chroot << 'EOF'
        #!/bin/sh
        useradd -m -s /bin/bash ogretmen
        echo "ogretmen:ogretmen123" | chpasswd
        usermod -aG sudo ogretmen
        EOF
        chmod +x config/hooks/normal/010-user.chroot

    - name: LightDM autologin + XFCE session
      run: |
        cd trixieedu
        mkdir -p config/includes.chroot/etc/lightdm
        cat > config/includes.chroot/etc/lightdm/lightdm.conf << 'EOF'
        [Seat:*]
        autologin-user=ogretmen
        autologin-session=xfce
        EOF

    - name: macOS style theme + Plank autostart
      run: |
        cd trixieedu
        mkdir -p config/includes.chroot/etc/skel/.config/autostart
        mkdir -p config/includes.chroot/etc/skel/.themes
        mkdir -p config/includes.chroot/etc/skel/.icons

        cat > config/includes.chroot/etc/skel/.config/autostart/plank.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=Plank
        Exec=plank
        X-GNOME-Autostart-enabled=true
        EOF

    - name: Set XFCE panel bottom
      run: |
        cd trixieedu
        mkdir -p config/includes.chroot/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
        cat > config/includes.chroot/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <channel name="xfce4-panel" version="1.0">
          <property name="panels">
            <value type="array">
              <value type="int" value="1"/>
            </value>
          </property>
          <property name="panels/panel-1/position" type="string" value="p=6;x=0;y=0"/>
          <property name="panels/panel-1/size" type="uint" value="40"/>
        </channel>
        EOF

    - name: Hide GRUB (direct boot)
      run: |
        cd trixieedu
        mkdir -p config/bootloaders/grub
        cat > config/bootloaders/grub/grub.cfg << 'EOF'
        set timeout=0
        set default=0
        menuentry "TrixieEdu" {
          linux /live/vmlinuz boot=live quiet splash
          initrd /live/initrd.img
        }
        EOF

    - name: Build ISO
      run: |
        cd trixieedu
        sudo lb build

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieEdu-XFCE-macOS-ISO
        path: trixieedu/*.iso

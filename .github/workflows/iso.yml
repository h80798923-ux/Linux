name: TrixieEdu Installer ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          live-build \
          debootstrap \
          squashfs-tools \
          xorriso \
          grub-pc-bin \
          grub-efi-amd64-bin \
          mtools

    - name: Build TrixieEdu ISO
      run: |
        mkdir trixieedu
        cd trixieedu

        lb config \
          --distribution bookworm \
          --archive-areas "main contrib non-free non-free-firmware" \
          --binary-images iso-hybrid \
          --bootappend-live "boot=live components installer" \
          --debian-installer live \
          --linux-flavours amd64 \
          --firmware-binary true \
          --firmware-chroot true

        # =========================
        # PACKAGE LIST
        # =========================
        mkdir -p config/package-lists
        cat > config/package-lists/edu.list.chroot << 'EOF'
        gnome-core
        gdm3
        network-manager
        firefox-esr
        libreoffice
        calamares
        sudo
        EOF

        # =========================
        # OS INFO
        # =========================
        mkdir -p config/includes.chroot/etc
        cat > config/includes.chroot/etc/os-release << 'EOF'
        NAME="TrixieEdu"
        ID=trixieedu
        VERSION="1.0"
        PRETTY_NAME="TrixieEdu Linux"
        EOF

        # =========================
        # HOOKS (KLASÃ–R HATASI FIX)
        # =========================
        mkdir -p config/hooks/normal

        cat > config/hooks/normal/010-fix-permissions.chroot << 'EOF'
        #!/bin/sh
        chmod 4755 /usr/bin/sudo || true
        EOF
        chmod +x config/hooks/normal/010-fix-permissions.chroot

        # =========================
        # BUILD ISO
        # =========================
        lb build
        mv live-image-amd64.hybrid.iso ../TrixieEdu-Installer.iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieEdu-Installer
        path: TrixieEdu-Installer.iso
